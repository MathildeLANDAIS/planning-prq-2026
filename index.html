<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- FORCE REDEPLOY GITHUB PAGES 2026-01-07 -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PLANNING PRQ 2026</title>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background:#f5f5f5; }
    h1 { text-align:center; margin: 10px 0 6px; }

    .topbar{
      max-width:1100px; margin: 0 auto 10px;
      padding: 10px 12px; background:white; border-radius: 10px;
      box-shadow:0 0 4px rgba(0,0,0,0.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap: wrap;
    }
    .topbar .left{display:flex; flex-direction:column; gap:4px;}
    .topbar .hint{margin:0; color:#555; font-size:0.9em;}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; font-size:0.75em; background:#eef2ff; color:#2b3a8a; margin-right:6px;}
    .btn{
      border:none; background:#111827; color:white; padding:8px 10px;
      border-radius:9px; cursor:pointer; font-size:0.85em;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    #weekdays {
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      max-width:1100px;
      margin: 0 auto;
    }
    .weekday { text-align:center; font-weight:bold; color:#555; padding:6px 0; }

    #calendar {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-top: 6px;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }

    .day {
      background: white;
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      min-height: 52px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      font-size: 0.9em;
      position: relative;
    }
    .day:hover { background:#e8f0fe; }
    .empty { background:transparent; box-shadow:none; cursor: default; }

    .separator {
      grid-column: 1 / -1;
      height: 1px;
      background:#888;
      margin: 8px 0;
      position: relative;
    }

    .month-label {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: -10px;
      background: #f5f5f5;
      padding: 0 6px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .events { margin-top:3px; font-size:0.78em; }
    .events.APV { color:#1d4ed8; }
    .events.VN { color:#f59e0b; }

    .holiday-mark {
      position:absolute;
      top:4px;
      right:6px;
      color:#d11a2a;
      font-weight:bold;
    }
    .holiday { outline:1px solid rgba(209,26,42,0.4); }

    #form {
      display:none;
      position: fixed;
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 0 14px rgba(0,0,0,0.25);
      z-index: 1000;
      width: 240px;
    }

    #listWrap { max-width:1100px; margin: 18px auto 0; }
    .event-item {
      background:white;
      margin-bottom:10px;
      padding:10px;
      border-radius:10px;
      box-shadow:0 0 4px rgba(0,0,0,0.1);
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:0.88em;
    }

    .agenda-link {
      background:#4285F4;
      color:white;
      padding:7px 10px;
      border-radius:8px;
      text-decoration:none;
      font-size:0.8em;
    }

    .delete-btn {
      background:#ff4d4d;
      color:white;
      border:none;
      padding:7px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size:0.8em;
    }

    .muted { color:#6b7280; font-size:0.85em; }
  </style>
</head>

<body>
<h1>PLANNING PRQ 2026</h1>

<div class="topbar">
  <div class="left">
    <p class="hint">
      <span class="pill">Aperçu</span>
      Clique sur une date → VN / APV → crée ton PRQ
    </p>
    <div class="muted" id="status">Connexion à la base…</div>
  </div>
  <button class="btn" id="refreshBtn">Rafraîchir</button>
</div>

<div id="weekdays">
  <div class="weekday">lun</div>
  <div class="weekday">mar</div>
  <div class="weekday">mer</div>
  <div class="weekday">jeu</div>
  <div class="weekday">ven</div>
</div>

<div id="calendar"></div>

<div id="listWrap">
  <h2>Mes PRQ</h2>
  <div id="list"></div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = 'https://tjqlvbfllxjfhotkuvrx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqcWx2YmZsbHhqZmhvdGt1dnJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDEzNTUsImV4cCI6MjA4MTM3NzM1NX0.kVAPjACIepzlScIUhuR23EydemxjAI0s-XMbVgpe5Pg';

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  { realtime: { enabled:false } }
);

/* ================= UI ================= */
const calendar = document.getElementById('calendar');
const listEl = document.getElementById('list');
const statusEl = document.getElementById('status');
const refreshBtn = document.getElementById('refreshBtn');

function setStatus(msg){ statusEl.textContent = msg; }

function showError(where, error){
  console.error(where, error);
  alert(`Erreur Supabase (${where}) :\n${error.message || error}`);
  setStatus('Erreur Supabase');
}

/* ================= DATA ================= */
let sharedByDate = {};

async function fetchShared(){
  setStatus('Chargement des PRQ…');
  const { data, error } = await supabase
    .from('prq_public')
    .select('id,date,type,ville')
    .order('date',{ascending:true});

  if(error){ showError('fetchShared', error); return; }

  sharedByDate = {};
  data.forEach(r=>{
    const d = r.date;
    if(!sharedByDate[d]) sharedByDate[d]=[];
    sharedByDate[d].push(r);
  });

  setStatus(`OK — ${data.length} PRQ`);
  renderCalendar();
}

/* ================= CALENDAR ================= */
function renderCalendar(){
  calendar.innerHTML='';
  const start = new Date(2026,0,1);
  const end   = new Date(2026,11,31);

  let week=[];
  let lastMonth=-1;

  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const dow=d.getDay();
    if(dow===0||dow===6) continue;

    if(d.getMonth()!==lastMonth){
      if(week.length) renderWeek(week);
      week=[];
      addSeparator(d.getMonth());
      lastMonth=d.getMonth();
    }

    week.push({date:new Date(d)});
    if(week.length===5){ renderWeek(week); week=[]; }
  }
  if(week.length) renderWeek(week);
}

function addSeparator(m){
  const s=document.createElement('div');
  s.className='separator';
  const l=document.createElement('span');
  l.className='month-label';
  l.textContent=[
    'JANVIER','FÉVRIER','MARS','AVRIL','MAI','JUIN',
    'JUILLET','AOÛT','SEPTEMBRE','OCTOBRE','NOVEMBRE','DÉCEMBRE'
  ][m];
  s.appendChild(l);
  calendar.appendChild(s);
}

function renderWeek(week){
  week.forEach(w=>{
    const div=document.createElement('div');
    div.className='day';
    const iso=w.date.toISOString().slice(0,10);
    div.innerHTML=`<strong>${w.date.getDate()}</strong>`;
    (sharedByDate[iso]||[]).forEach(e=>{
      const s=document.createElement('div');
      s.className='events '+e.type;
      s.textContent=`PRQ ${e.type} ${e.ville}`;
      div.appendChild(s);
    });
    calendar.appendChild(div);
  });
}

/* ================= INIT ================= */
refreshBtn.onclick = fetchShared;
fetchShared();
</script>
</body>
</html>
