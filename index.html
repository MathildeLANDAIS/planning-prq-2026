<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PLANNING PRQ 2026</title>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background:#f5f5f5; }
    h1 { text-align:center; margin: 10px 0 6px; }

    .topbar{
      max-width:1100px; margin: 0 auto 10px;
      padding: 10px 12px; background:white; border-radius: 10px;
      box-shadow:0 0 4px rgba(0,0,0,0.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap: wrap;
    }
    .topbar .left{display:flex; flex-direction:column; gap:4px;}
    .topbar .hint{margin:0; color:#555; font-size:0.9em;}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; font-size:0.75em; background:#eef2ff; color:#2b3a8a; margin-right:6px;}
    .btn{
      border:none; background:#111827; color:white; padding:8px 10px;
      border-radius:9px; cursor:pointer; font-size:0.85em;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    #weekdays {
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      max-width:1100px;
      margin: 0 auto;
    }
    .weekday { text-align:center; font-weight:bold; color:#555; padding:6px 0; }

    #calendar {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-top: 6px;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }

    .day {
      background: white;
      padding: 6px 6px 5px;
      border-radius: 8px;
      cursor: pointer;
      min-height: 52px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
      font-size: 0.9em;
    }
    .day:hover { background:#e8f0fe; }
    .empty { background:transparent; box-shadow:none; cursor: default; }

    .separator {
      grid-column: 1 / -1;
      height: 1px;
      background:#888;
      margin: 8px 0;
      position: relative;
    }

    .month-label {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: -10px;
      background: #f5f5f5;
      padding: 0 6px;
      font-weight: bold;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .events { margin-top:3px; font-size:0.78em; color:#444; line-height:1.15; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .events.APV { color: #1d4ed8; }
    .events.VN { color: #f59e0b; }

    .holiday-mark {
      position:absolute;
      top: 4px;
      right: 6px;
      font-weight: 900;
      font-size: 0.95em;
      color: #d11a2a;
      user-select: none;
    }
    .holiday { outline: 1px solid rgba(209,26,42,0.35); }

    #form {
      display:none;
      position: fixed;
      background: white;
      padding: 12px 12px 10px;
      border-radius: 10px;
      box-shadow: 0 0 14px rgba(0,0,0,0.25);
      z-index: 1000;
      width: 240px;
    }
    #form h2 { margin:0 0 8px; font-size:1.05em; }
    #form label { display:block; font-size:0.9em; color:#333; margin-top:6px; }
    #form select, #form button {
      padding: 7px;
      margin: 6px 0;
      width: 100%;
      font-size: 0.9em;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }
    #form button { border:none; cursor:pointer; }
    #saveBtn { background:#2563eb; color:white; }
    #closeBtn { background:#888; color:white; }

    #listWrap { max-width:1100px; margin: 18px auto 0; }
    #list { margin-top:10px; }
    .event-item {
      background:white; margin-bottom:10px; padding:10px;
      border-radius:10px; box-shadow:0 0 4px rgba(0,0,0,0.1);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      font-size:0.88em; transition: background 0.2s;
    }
    .event-item:hover { background:#f0f4ff; }
    .event-left { display:flex; flex-direction:column; flex:1; }
    .delete-btn {
      background:#ff4d4d; color:white; border:none;
      padding:7px 10px; cursor:pointer; border-radius:8px;
      font-size:0.82em; min-width:120px; text-align:center;
      transition: background 0.2s;
    }
    .delete-btn:hover { background:#e60000; }
    .agenda-link {
      font-size:0.82em; background:#4285F4; color:white;
      padding:7px 10px; border-radius:8px; text-decoration:none;
      display:inline-block; min-width:120px; text-align:center;
      transition: background 0.2s; white-space:nowrap;
    }
    .agenda-link:hover { background:#3367d6; }

    .muted{color:#6b7280; font-size:0.85em;}
  </style>
</head>
<body>
  <h1>PLANNING PRQ 2026</h1>

  <div class="topbar">
    <div class="left">
      <p class="hint" style="margin:0">
        <span class="pill">Aperçu</span>
        Clique sur une date → choisis <b>VN/APV</b> + <b>Affaire</b> → crée ton PRQ.
        En bas: <b>Mes PRQ</b> (lien Google Agenda + supprimer).
      </p>
      <div class="muted" id="status">Connexion à la base…</div>
    </div>
    <div>
      <button class="btn" id="refreshBtn" type="button">Rafraîchir</button>
    </div>
  </div>

  <div id="weekdays" style="margin-top:12px">
    <div class="weekday">lun</div>
    <div class="weekday">mar</div>
    <div class="weekday">mer</div>
    <div class="weekday">jeu</div>
    <div class="weekday">ven</div>
  </div>

  <div id="calendar"></div>

  <div id="form" role="dialog" aria-modal="true">
    <h2 id="dateLabel"></h2>

    <label for="type">Type de réunion :</label>
    <select id="type">
      <option value="VN">VN</option>
      <option value="APV">APV</option>
    </select>

    <label for="ville">Affaire / Ville :</label>
    <select id="ville">
      <option>ANGERS</option>
      <option>BRESSUIRE</option>
      <option>PORNIC</option>
      <option>LA ROCHE</option>
      <option>CLISSON</option>
      <option>CHOLET</option>
      <option>REZE</option>
      <option>LES HERBIERS</option>
      <option>CARQUEFOU</option>
      <option>LUCON</option>
      <option>CHALLANS</option>
      <option>SAUMUR</option>
      <option>LES SABLES</option>
      <option>THOUARS</option>
      <option>NANTES</option>
    </select>

    <button id="saveBtn" type="button">Enregistrer un PRQ</button>
    <button id="closeBtn" type="button">Fermer</button>

    <div class="muted" style="margin-top:6px;">
      Astuce: <b>ESC</b> ou clic extérieur pour fermer.
    </div>
  </div>

  <div id="listWrap">
    <h2>Mes PRQ</h2>
    <div id="list"></div>
    <div class="muted" style="margin-top:6px;">Note: “Mes PRQ” est lié à ce navigateur (comme un cookie). Sur un autre ordinateur, ta liste ne sera pas la même.</div>
  </div>

  <script>
    // === Supabase config ===
    const SUPABASE_URL = 'https://tjqlvbfllxjfhotkuvrx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqcWx2YmZsbHhqZmhvdGt1dnJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDEzNTUsImV4cCI6MjA4MTM3NzM1NX0.kVAPjACIepzlScIUhuR23EydemxjAI0s-XMbVgpe5Pg';

    // ✅ Fix 1: désactiver Realtime (évite les blocages WebSocket sur sites statiques)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      realtime: { enabled: false }
    });

    // === UI refs ===
    const calendar = document.getElementById('calendar');
    const listEl = document.getElementById('list');
    const formEl = document.getElementById('form');
    const dateLabelEl = document.getElementById('dateLabel');
    const saveBtn = document.getElementById('saveBtn');
    const closeBtn = document.getElementById('closeBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');

    const weekdaysAbbrev = ['lun','mar','mer','jeu','ven'];
    const monthNames = ['JANVIER','FÉVRIER','MARS','AVRIL','MAI','JUIN','JUILLET','AOÛT','SEPTEMBRE','OCTOBRE','NOVEMBRE','DÉCEMBRE'];

    const holidaysAll2026 = {
      "2026-01-01": "Jour de l’an",
      "2026-04-06": "Lundi de Pâques",
      "2026-05-01": "Fête du Travail",
      "2026-05-08": "Victoire 1945",
      "2026-05-14": "Ascension",
      "2026-05-25": "Lundi de Pentecôte",
      "2026-07-14": "Fête nationale",
      "2026-08-15": "Assomption",
      "2026-11-01": "Toussaint",
      "2026-11-11": "Armistice 1918",
      "2026-12-25": "Noël"
    };

    function isoDateLocal(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function dateFromIsoLocal(iso) {
      const parts = iso.split('-').map(Number);
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function buildWeekdayHolidayMap(allMap) {
      const out = {};
      for (const [iso, label] of Object.entries(allMap)) {
        const dt = dateFromIsoLocal(iso);
        const dow = dt.getDay();
        if (dow >= 1 && dow <= 5) out[iso] = label;
      }
      return out;
    }

    const holidays2026 = buildWeekdayHolidayMap(holidaysAll2026);

    let sharedByDate = {};

    const MY_KEY = 'my_prq_2026_v2';
    let myList = [];

    function loadMyList() {
      try {
        myList = JSON.parse(localStorage.getItem(MY_KEY) || '[]');
        if (!Array.isArray(myList)) myList = [];
      } catch {
        myList = [];
      }
    }

    function saveMyList() {
      localStorage.setItem(MY_KEY, JSON.stringify(myList));
    }

    function buildAgendaUrl(dateIso, desc) {
      const start = dateIso.replace(/-/g, '') + 'T090000';
      const end = dateIso.replace(/-/g, '') + 'T100000';
      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(desc)}&dates=${start}%2F${end}`;
    }

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function addMonthSeparator(monthIndex) {
      const separator = document.createElement('div');
      separator.className = 'separator';
      const label = document.createElement('span');
      label.className = 'month-label';
      label.textContent = monthNames[monthIndex];
      separator.appendChild(label);
      calendar.appendChild(separator);
    }

    let selectedDate = null;

    function openForm(dateStr, evt) {
      selectedDate = dateStr;
      dateLabelEl.textContent = `PRQ le ${dateStr.split('-').reverse().join('/')}`;

      const padding = 10;
      formEl.style.display = 'block';

      const rect = formEl.getBoundingClientRect();
      let x = evt.clientX;
      let y = evt.clientY;
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      if (x + rect.width + padding > vw) x = vw - rect.width - padding;
      if (y + rect.height + padding > vh) y = vh - rect.height - padding;
      if (x < padding) x = padding;
      if (y < padding) y = padding;

      formEl.style.left = x + 'px';
      formEl.style.top = y + 'px';
    }

    function closeForm() {
      formEl.style.display = 'none';
      selectedDate = null;
    }

    function toSharedMap(rows) {
      const map = {};
      for (const r of rows) {
        const dateIso = String(r.date).slice(0, 10);
        if (!map[dateIso]) map[dateIso] = [];
        map[dateIso].push({
          id: r.id,
          date: dateIso,
          type: r.type,
          ville: r.ville,
        });
      }
      return map;
    }

    // ✅ Fix 2: afficher l’erreur Supabase au lieu de rester bloqué
    function showSupabaseError(context, error) {
      console.error(context, error);
      const msg = (error && error.message) ? error.message : String(error || 'Erreur inconnue');
      setStatus(`Erreur Supabase: ${msg}`);
      alert(`Erreur Supabase (${context}) :\n${msg}`);
    }

    async function fetchShared() {
      setStatus('Chargement des PRQ partagés…');
      refreshBtn.disabled = true;

      const { data, error } = await supabase
        .from('prq_public')
        .select('id,date,type,ville,created_at')
        .gte('date', '2026-01-01')
        .lte('date', '2026-12-31')
        .order('date', { ascending: true })
        .limit(1000);

      refreshBtn.disabled = false;

      if (error) {
        showSupabaseError('fetchShared', error);
        return;
      }

      sharedByDate = toSharedMap(data || []);
      setStatus(`OK — ${data?.length || 0} PRQ chargés.`);
      renderCalendar();
    }

    async function createPrq(dateIso, type, ville) {
      const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + Math.random();
      const delete_secret = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + Math.random();

      const row = { id, date: dateIso, type, ville, delete_secret };

      // (On garde ton choix : insertion dans la table 'prq' + secret local pour suppression)
      const { error } = await supabase.from('prq').insert(row);
      if (error) throw error;

      myList.push({ id, delete_secret, date: dateIso, type, ville });
      saveMyList();

      if (!sharedByDate[dateIso]) sharedByDate[dateIso] = [];
      sharedByDate[dateIso].push({ id, date: dateIso, type, ville });
    }

    async function deletePrq(id, secret) {
      const { data, error } = await supabase.rpc('delete_prq', { p_id: id, p_secret: secret });
      if (error) throw error;
      return !!data;
    }

    async function saveEvent() {
      if (!selectedDate) return;

      saveBtn.disabled = true;
      setStatus('Enregistrement…');

      const type = document.getElementById('type').value;
      const ville = document.getElementById('ville').value;

      try {
        await createPrq(selectedDate, type, ville);
        setStatus('PRQ enregistré ✅');
        renderList();
        renderCalendar();
        closeForm();
      } catch (e) {
        showSupabaseError('createPrq', e);
        setStatus('Erreur lors de l’enregistrement.');
      } finally {
        saveBtn.disabled = false;
      }
    }

    async function onDeleteClick(item) {
      const ok = confirm('Supprimer ce PRQ ?');
      if (!ok) return;

      try {
        setStatus('Suppression…');
        const success = await deletePrq(item.id, item.delete_secret);
        if (!success) {
          alert('Impossible de supprimer (droits manquants ou PRQ déjà supprimé).');
          setStatus('Suppression refusée.');
          return;
        }

        myList = myList.filter(x => x.id !== item.id);
        saveMyList();

        const arr = sharedByDate[item.date] || [];
        sharedByDate[item.date] = arr.filter(x => x.id !== item.id);
        if (sharedByDate[item.date].length === 0) delete sharedByDate[item.date];

        renderList();
        renderCalendar();
        setStatus('PRQ supprimé ✅');
      } catch (e) {
        showSupabaseError('deletePrq', e);
        setStatus('Erreur lors de la suppression.');
      }
    }

    function renderList() {
      listEl.innerHTML = '';

      if (!myList.length) {
        listEl.innerHTML = `<div class="muted">Aucun PRQ créé pour l’instant. Clique sur une date pour en ajouter.</div>`;
        return;
      }

      const sorted = [...myList].sort((a,b) => a.date.localeCompare(b.date));

      for (const item of sorted) {
        const div = document.createElement('div');
        div.className = 'event-item';

        const desc = `PRQ ${item.type} ${item.ville}`;
        const agendaUrl = buildAgendaUrl(item.date, desc);

        div.innerHTML = `
          <div class='event-left'>
            <strong>${item.date.split('-').reverse().join('/')}</strong>
            <span>PRQ ${item.type} ${item.ville}</span>
          </div>
          <a class='agenda-link' href="${agendaUrl}" target="_blank" rel="noopener">Google Agenda</a>
          <button class='delete-btn' type='button'>Supprimer</button>
        `;

        div.querySelector('.delete-btn').addEventListener('click', () => onDeleteClick(item));
        listEl.appendChild(div);
      }
    }

    function renderWeek(week) {
      for (const item of week) {
        const div = document.createElement('div');

        if (item.empty) {
          div.className = 'day empty';
          calendar.appendChild(div);
          continue;
        }

        const dateStr = isoDateLocal(item.date);
        const dow = item.date.getDay();

        div.className = 'day';
        div.dataset.date = dateStr;

        if (holidays2026[dateStr]) {
          div.classList.add('holiday');
          div.title = holidays2026[dateStr];
          const cross = document.createElement('span');
          cross.className = 'holiday-mark';
          cross.textContent = '✖';
          div.appendChild(cross);
        }

        const dayNum = item.date.getDate();
        const abbrev = weekdaysAbbrev[dow - 1] || '';
        div.innerHTML += `<strong>${dayNum}</strong> <em style="color:#666">(${abbrev})</em>`;

        const shared = sharedByDate[dateStr] || [];
        for (const ev of shared) {
          const evSpan = document.createElement('div');
          evSpan.className = 'events ' + ev.type;
          evSpan.textContent = `PRQ ${ev.type} ${ev.ville}`;
          div.appendChild(evSpan);
        }

        div.addEventListener('click', (e) => openForm(dateStr, e));
        calendar.appendChild(div);
      }
    }

    function renderCalendar() {
      calendar.innerHTML = '';

      const start = new Date(2026, 0, 1);
      const end = new Date(2026, 11, 31);

      let week = [];
      let lastMonth = null;

      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dow = d.getDay();
        if (dow === 0 || dow === 6) continue;

        if (lastMonth === null || d.getMonth() !== lastMonth) {
          if (week.length) {
            renderWeek(week);
            week = [];
          }
          addMonthSeparator(d.getMonth());
          lastMonth = d.getMonth();
        }

        if (week.length === 0 && dow !== 1) {
          for (let i = 1; i < dow; i++) week.push({ empty: true });
        }

        week.push({ date: new Date(d) });

        if (week.length === 5) {
          renderWeek(week);
          week = [];
        }
      }

      if (week.length) renderWeek(week);
    }

    document.addEventListener('mousedown', (e) => {
      if (formEl.style.display === 'block' && !formEl.contains(e.target)) {
        const dayCell = e.target.closest && e.target.closest('.day');
        if (!dayCell) closeForm();
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeForm();
    });

    saveBtn.addEventListener('click', saveEvent);
    closeBtn.addEventListener('click', closeForm);
    refreshBtn.addEventListener('click', fetchShared);

    window.__prq = {
      refresh: fetchShared,
      my: () => myList,
      clearMy: () => { localStorage.removeItem(MY_KEY); loadMyList(); renderList(); },
    };

    (function init() {
      loadMyList();
      renderList();
      renderCalendar();
      fetchShared();
    })();
  </script>
</body>
</html>
